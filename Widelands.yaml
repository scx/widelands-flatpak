name: Widelands
buildsystem: cmake-ninja
builddir: true
config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DCMAKE_INSTALL_PREFIX=/app/bin
  - -DWL_INSTALL_BASEDIR=/app/share/widelands
  - -DWL_INSTALL_DATADIR=/app/share/widelands
  - -DBOOST_ROOT=/app
  - -DGLEW_ROOT=/app
  - -DGLEW_INCLUDE_DIR=/app/include/GL
  # https://wl.widelands.org/forum/topic/1343/?page=3 & https://wl.widelands.org/forum/post/9857/
  - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
  - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
  - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
build-options:
  ldflags: -lGL
sources:
  # Source0
  - type: git
    url: https://github.com/widelands/widelands.git
    commit: 87b0494698ffabcc8d39d66e6309b1449a057acd
  # Patch4
  # Move XDG-related stuff from debian/rules to xdg/CMakeLists.txt
  # https://github.com/widelands/widelands/pull/3547
  - type: patch
    path: widelands-build20-xdg-cmake.patch
    use-git: true
  # https://github.com/widelands/widelands/issues/3558
  - type: shell
    commands:
      - |
        version_old="$( xmlstarlet sel -t -v '/component/releases/release[1]/@version' -n "xdg/${FLATPAK_ID}.appdata.xml" )";
        version_new="$( echo "${version_old}" | ruby -e 'puts $stdin.read.gsub(/([0-9]+)/) { |m| (m.to_i + 1).to_s }' )";
        WL_VERSION="$( python2 utils/detect_revision.py 2> /dev/null )";
        version_git="${WL_VERSION}";
        if [[ ! "${WL_VERSION}" =~ ^build-[0-9]+$ || "${WL_VERSION}" =~ ^r[0-9]+ ]]; then
          revision_git="${WL_VERSION%[*}";
          [[ -z "${revision_git}" ]] || version_git="${version_new}~${revision_git}";
        fi;
        echo "${version_git}" > "WL_VERSION";
        echo "${version_old}";
        echo "${version_git}";
      - cp -p "WL_VERSION" "WL_RELEASE";
post-install:
  # https://github.com/hughsie/appstream-glib/pull/272#issuecomment-439812546
  # https://bugs.launchpad.net/widelands/+bug/1807625
  - |
    for f in "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml"; do
      xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' "${f}";
    done;
  # https://github.com/widelands/widelands/issues/3558#issuecomment-553567846
  - |
    version_old="$( xmlstarlet sel -t -v '/component/releases/release[1]/@version' -n "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml" )";
    version_git="$( cat "../WL_VERSION" 2> /dev/null )";
    if [[ -n "${version_git}" && "${version_git}" != "${version_old}" ]]; then
      date_git="$( git log HEAD -1 --format="%at" 2> /dev/null | xargs -I{} date -d @{} +%Y-%m-%d 2> /dev/null )";
      xmlstarlet ed --inplace -i '/component/releases/release[1]' -t elem -n 'release' -s '/component/releases/release[1]' -t attr -n 'date' -v "${date_git}" -s '/component/releases/release[1]' -t attr -n 'version' -v "${version_git}" -s '/component/releases/release[1]' -t attr -n 'type' -v "development" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml";
    fi;
  - install -p -D -m 0644 "../ChangeLog" "../CREDITS" -t "${FLATPAK_DEST}/share/doc/widelands/";
  - install -p -D -m 0644 "../COPYING" -t "${FLATPAK_DEST}/share/licenses/widelands/";
modules:
  - shared-modules/lua5.3/lua-5.3.5.json
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - shared-modules/python2.7/python-2.7.json
  - boost.yaml
  - xmlstarlet.yaml
