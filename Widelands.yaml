name: Widelands
buildsystem: cmake-ninja
builddir: true
config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DCMAKE_INSTALL_PREFIX=/app/bin
  - -DWL_INSTALL_BASEDIR=/app/share/widelands
  - -DWL_INSTALL_DATADIR=/app/share/widelands
  - -DBOOST_ROOT=/app
  - -DGLEW_ROOT=/app
  - -DGLEW_INCLUDE_DIR=/app/include/GL
  # Fix an issue with linking libs
  # https://www.widelands.org/forum/topic/1343/?page=3#post-9857
  - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
  - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
  - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
build-options:
  ldflags: -lGL
sources:
  - type: archive
    url: https://launchpad.net/widelands/build20/build20/+download/widelands-build20.tar.bz2
    sha256: 38594d98c74f357d4c31dd8ee2b056bfe921f42935935af915d11b792677bcb2
    git-init: true
  # Implement support for GCC 9
  # https://bugs.launchpad.net/widelands/+bug/1831359
  - type: patch
    path: widelands-build20-gcc.patch
  # Build order for -lGL does not work
  # https://bugs.launchpad.net/widelands/+bug/1836107
  # undefined reference to `glReadPixels'
  - type: patch
    path: widelands-build20-gl.patch
  # Update translations
  - type: patch
    path: widelands-build20-xdg-translations.patch
    use-git: true
  # Move XDG-related stuff from debian/rules to xdg/CMakeLists.txt
  # https://github.com/widelands/widelands/pull/3547
  - type: patch
    path: widelands-build20-xdg-cmake.patch
    use-git: true
post-install:
  - |
    for f in "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml"; do
      # Remove all but the newest release from the AppData file, because appstream-glib is broken, and the file does not pass validation
      # https://github.com/hughsie/appstream-glib/pull/272#issuecomment-439812546
      xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' "${f}";
    done;
  - install -p -D -m 0644 "../ChangeLog" "../CREDITS" -t "${FLATPAK_DEST}/share/doc/widelands/";
  - install -p -D -m 0644 "../COPYING" -t "${FLATPAK_DEST}/share/licenses/widelands/";
modules:
  - shared-modules/lua5.3/lua-5.3.5.json
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - shared-modules/python2.7/python-2.7.json
  - boost.yaml
  - xmlstarlet.yaml
