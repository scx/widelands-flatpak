name: Widelands
buildsystem: cmake-ninja
builddir: true
config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DCMAKE_INSTALL_PREFIX=/app/bin
  - -DWL_INSTALL_BASEDIR=/app/share/widelands
  - -DWL_INSTALL_DATADIR=/app/share/widelands
  - -DBOOST_ROOT=/app
  - -DGLEW_ROOT=/app
  - -DGLEW_INCLUDE_DIR=/app/include/GL
  # https://wl.widelands.org/forum/topic/1343/?page=3 & https://wl.widelands.org/forum/post/9857/
  - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
  - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
  - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
build-options:
  ldflags: -lGL
sources:
  # Source0
  - type: archive
    url: https://launchpad.net/widelands/build20/build20/+download/widelands-build20.tar.bz2
    sha256: 38594d98c74f357d4c31dd8ee2b056bfe921f42935935af915d11b792677bcb2
  # Patch1
  - type: patch
    path: widelands-build20-gcc.patch
  # Patch2
  # https://bugs.launchpad.net/widelands/+bug/1836107
  # undefined reference to `glReadPixels'
  - type: patch
    path: widelands-build20-gl.patch
post-install:
  # https://bugs.launchpad.net/widelands/+bug/1807625
  - |
    for f in "../debian/org.widelands.widelands.desktop"; do
      desktop-file-edit --set-key='X-Flatpak-RenamedFrom' --set-value="${FLATPAK_ID,,}.desktop;${FLATPAK_ID,,};" "${f}";
      desktop-file-edit --set-key='Keywords' --set-value='Game;RTS;Real-time;Strategy;' "${f}";
    done;
  # https://github.com/hughsie/appstream-glib/pull/272#issuecomment-439812546
  # https://bugs.launchpad.net/widelands/+bug/1807625
  - |
    for f in "../debian/widelands.appdata.xml"; do
      xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' "${f}";
      xmlstarlet ed --inplace -d '/component/icon' "${f}";
      xmlstarlet ed --inplace -u '/component/id' -v "${FLATPAK_ID}" "${f}";
      xmlstarlet ed --inplace -u '/component/launchable' -v "${FLATPAK_ID}.desktop" "${f}";
      [[ "$( xmlstarlet sel -t -v "/component/provides/id='${FLATPAK_ID,,}.desktop'" "${f}" )" == 'true' ]] || xmlstarlet ed --inplace -s '/component/provides' -t elem -n 'id' -v "${FLATPAK_ID,,}.desktop" "${f}";
      [[ "$( xmlstarlet sel -t -v "/component/provides/id='${FLATPAK_ID,,}'" "${f}" )" == 'true' ]] || xmlstarlet ed --inplace -s '/component/provides' -t elem -n 'id' -v "${FLATPAK_ID,,}" "${f}";
    done;
  - |
    for s in {16,32,48,64,128}; do
      install -p -D -m 0644 "../data/images/logos/wl-ico-${s}.png" "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${FLATPAK_ID}.png";
    done;
  - install -p -D -m 0644 "../debian/org.widelands.widelands.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop";
  - install -p -D -m 0644 "../debian/widelands.appdata.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml";
